name: Deploy to AET Cluster

on:
  workflow_run:
    workflows: ["Build & Push All Docker Images"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest

    env:
      NAMESPACE: aihr
      CHART_DIR: ./charts/aihr

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Decode kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Deploy Helm chart to production (main branch)
        if: github.event_name == 'workflow_run' && github.event.workflow_run.head_branch == 'main'
        run: |
          helm upgrade --install aihr "$CHART_DIR" \
            --namespace "$NAMESPACE" --create-namespace \
            --set postgresql.password="$POSTGRES_PASSWORD" \
            --set services.auth.tag="$AUTH_TAG" \
            --set services.auth.env.DB_PASSWORD="$DB_PASSWORD" \
            --set services.auth.env.JWT_PRIVATE_KEY="$JWT_PRIVATE_KEY" \
            --set services.auth.env.JWT_PUBLIC_KEY="$JWT_PUBLIC_KEY" \
          
            --set services.job.tag="$JOB_TAG" \
            --set services.job.env.DB_PASSWORD="$DB_PASSWORD" \
          
            --set services.application.tag="$APPLICATION_TAG" \
            --set services.application.env.DB_PASSWORD="$DB_PASSWORD" \
            --set services.application.env.RESUME_UPLOAD_PATH="$RESUME_UPLOAD_PATH" \
          
            --set services.assess.tag="$ASSESS_TAG" \
            --set services.assess.env.DB_PASSWORD="$DB_PASSWORD" \
          
            --set services.genai.tag="$GENAI_TAG" \
            --set services.genai.env.PYTHONDONTWRITEBYTECODE="$PYTHONDONTWRITEBYTECODE" \
            --set services.genai.env.PYTHONUNBUFFERED="$PYTHONUNBUFFERED" \
            --set services.genai.env.DATABASE_URL="$DATABASE_URL" \
            --set services.genai.env.ALLOW_ORIGINS="$ALLOW_ORIGINS" \
          
            --set ingress.hosts[0].host="api.aihr.student.k8s.aet.cit.tum.de" \
            --set ingress.hosts[1].host="dev.api.aihr.student.k8s.aet.cit.tum.de" \
            --set ingress.tls=true

      - name: Deploy Helm chart manually (other branches)
        if: github.event_name == 'workflow_dispatch'
        run: |
          # 你可以这里传入分支名参数，或者用环境变量控制部署到 dev 域名
          helm upgrade --install aihr $CHART_DIR \
            --namespace $NAMESPACE --create-namespace \
            --set postgresql.password="${{ secrets.DB_PASSWORD }}" \
            --set services.auth.env.DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            --set services.auth.env.JWT_PRIVATE_KEY="${{ secrets.JWT_PRIVATE_KEY }}" \
            --set services.auth.env.JWT_PUBLIC_KEY="${{ secrets.JWT_PUBLIC_KEY }}" \
            --set services.auth.tag="dev-${{ github.sha }}" \
            --set services.job.tag="dev-${{ github.sha }}" \
            --set services.application.tag="dev-${{ github.sha }}" \
            --set services.assess.tag="dev-${{ github.sha }}" \
            --set services.genai.tag="dev-${{ github.sha }}" \
            --set ingress.hosts[0].host="dev.api.aihr.student.k8s.aet.cit.tum.de" \
            --set ingress.hosts[1].host="dev.api.aihr.student.k8s.aet.cit.tum.de"
